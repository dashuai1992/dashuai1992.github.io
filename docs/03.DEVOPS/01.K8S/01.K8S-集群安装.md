---
title: K8S-é›†ç¾¤å®‰è£…(2.24å‰åç‰ˆæœ¬çš„å®‰è£…æ–¹å¼éƒ½æœ‰)
date: 2020-07-22 21:41:46
permalink: /pages/f6c671/
titleTag: ç²¾
sticky: 1
categories:
  - DEVOPS
  - K8S
tags:
  - K8S
author: 
  name: yds
  link: https://github.com/dashuai1992
---

# K8Så®‰è£… â˜¸ï¸

æœ¬æ–‡ä»‹ç»äº†å®‰è£…k8sé›†ç¾¤çš„ä¸€ç§æ–¹å¼ï¼Œä½¿ç”¨kubeadmå¿«é€Ÿæ„å»ºä¸€å¥—å¯ç”¨çš„æ ‡å‡†çš„k8sé›†ç¾¤ ğŸ˜ã€‚å®‰è£…çš„è¿‡ç¨‹ä¸­ï¼Œä¸åŒæ—¶æœŸçš„ç‰ˆæœ¬æ˜¯æœ‰äº›è®¸å·®å¼‚çš„ğŸ˜±ï¼Œæ¯”è¾ƒæ˜æ˜¾çš„å·®å¼‚å°±æ˜¯åœ¨2.24ä¹‹åï¼Œdockerä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦é€šè¿‡criæ¥è¿›è¡Œé€‚é…ã€‚

<!-- more -->


### ç¯å¢ƒå‡†å¤‡
- 3ï¸âƒ£å°linuxæœåŠ¡å™¨
- ç½‘ç»œğŸ›œå¯ç”¨

- ä¿®æ”¹æ¯ä¸ªæœåŠ¡å™¨çš„hostsæ–‡ä»¶ğŸ“ƒ
```shell
vim /etc/hosts  
```

```txt
192.168.0.75 master01  
192.168.0.76 node01  
192.168.0.77 node02
```
- ğŸ”å…³é—­é˜²ç«å¢™
```shell
systemctl stop firewalld  

systemctl disable firewalld
```

- âŒå…³é—­swapï¼Œæ³¨é‡Šswapåˆ†åŒº
```shell
setenforce 0

sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config

swapoff -a

sed -i 's/.*swap.*/#&/' /etc/fstab
```

- é…ç½®å†…æ ¸å‚æ•°ï¼Œå°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾
```shell
cat > /etc/sysctl.d/k8s.conf <<EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
```
```shell 
sysctl --system
```

### å®‰è£…å¸¸ç”¨åŒ…å·¥å…·ğŸ› ï¸
```shell 
yum install vim bash-completion net-tools gcc -y
```

### å®‰è£…dockerğŸ³
```shell
yum install -y yum-utils device-mapper-persistent-data lvm2

yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

yum -y install docker-ce
```

::: details tips ğŸ“£

æˆ‘ä¹‹å‰åœ¨å®‰è£…dockerçš„æ—¶å€™æ€»æ˜¯ä¼šæœ‰runcçš„é—®é¢˜ ğŸŒšï¼Œå¦‚æœåœ¨å®‰è£…è¿‡ç¨‹ä¸­é‡åˆ°äº†å°±ç»™runcé‡è£…ä¸€ä¸‹ğŸ‘»
```shell 
yum remove runc -y

yum install runc -y

yum -y install docker-ce
```

:::


### ğŸ›«æ·»åŠ aliyundockerä»“åº“åŠ é€Ÿå™¨ğŸš€

```shell
mkdir -p /etc/docker

tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://reg-mirror.qiniu.com/"]
}
EOF
```

### å¯åŠ¨docker ğŸ•¹ï¸
```shell
systemctl daemon-reload

systemctl enable docker

systemctl restart docker
```

### å®‰è£…k8s â˜¸ï¸
- å®‰è£…kubectlã€kubeletã€kubeadm

```shell
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

yum update
```

<br/>

 ğŸ„
--- 
<br/>


ğŸ‘‰ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä»¥ä¸Šæ­¥éª¤å„ä¸ªç‰ˆæœ¬éƒ½æ˜¯é€‚ç”¨çš„ğŸ’„ï¼Œæ¥ä¸‹æ¥å°†ä»¥<Badge text="1.18"/>å’Œ<Badge text="1.28"/>ä¸¤ä¸ªç‰ˆæœ¬ä¸ºä¾‹åˆ†åˆ«å±•å¼€è®°å½•å®‰è£…æ­¥éª¤ğŸ’¦

### 1.18ç‰ˆæœ¬

```å®‰è£…1.18.0ï¼Œè¿™ä¸ªç‰ˆæœ¬æ˜¯ç›¸å¯¹ç¨³å®šçš„ç‰ˆæœ¬ï¼ŒåŒæ—¶ä¸‹è½½çš„æ—¶å€™æ²¡æœ‰ç½‘ç»œçš„é™åˆ¶ï¼Œæ›´æ–°çš„ç‰ˆæœ¬ä¸‹è½½æ—¶å¯èƒ½ä¼šé‡åˆ°å›½å†…æºä¸è¶³çš„é—®é¢˜ï¼Œå›½å¤–çš„å› ä¸ºç½‘ç»œé—®é¢˜ï¼Œä¸‹è½½ä¸ä¸‹æ¥```

::: details tips ğŸ“£

å®‰è£…1.18.0ï¼Œè¿™ä¸ªç‰ˆæœ¬æ˜¯ç›¸å¯¹ç¨³å®šçš„ç‰ˆæœ¬ï¼ŒåŒæ—¶ä¸‹è½½çš„æ—¶å€™æ²¡æœ‰ç½‘ç»œçš„é™åˆ¶ï¼Œæ›´æ–°çš„ç‰ˆæœ¬ä¸‹è½½æ—¶å¯èƒ½ä¼šé‡åˆ°å›½å†…æºä¸è¶³çš„é—®é¢˜ï¼Œå›½å¤–çš„å› ä¸ºç½‘ç»œé—®é¢˜ï¼Œä¸‹è½½ä¸ä¸‹æ¥ã€‚ 

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ—ä¸¾å‡ºå½“å‰å¯ä»¥å®‰è£…çš„k8sè½¯ä»¶ç‰ˆæœ¬
```shell
yum list kubelet kubeadm kubectl  --showduplicates|sort -r
```

:::

- å®‰è£…
```shell
yum install kubelet-1.18.0-0 kubeadm-1.18.0-0  kubectl-1.18.0-0 -y

## è·³è¿‡å…¬é’¥æ£€æŸ¥
yum install kubelet-1.18.0-0 kubeadm-1.18.0-0  kubectl-1.18.0-0 -y --nogpgcheck

systemctl enable kubelet
```

```ä»¥ä¸Šæ­¥éª¤å„ä¸ªèŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ```

- masterä¸Šåˆå§‹åŒ–k8sé›†ç¾¤
```shell
kubeadm init \
--kubernetes-version=1.18.0 \
--apiserver-advertise-address=192.168.60.75 \
--image-repository registry.aliyuncs.com/google_containers \
--service-cidr=10.1.0.0/16 \
--pod-network-cidr=10.244.0.0/16
```
```--apiserver-advertise-address æœ¬æœºçš„ipï¼Œå…¶å®ƒéƒ¨åˆ†ä¸ç”¨åŠ¨ï¼Œ è®°ä½è¿™ä¸€æ­¥æ‰§è¡Œå®Œæˆåçš„è¿”å›ä¿¡æ¯ï¼ŒnodeåŠ å…¥é›†ç¾¤æ—¶è¦ç”¨```

- kubectlå‘½ä»¤å¯ç”¨
```shell
mkdir -p $HOME/.kube

sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config

sudo chown $(id -u):$(id -g) $HOME/.kube/config

source <(kubectl completion bash)

```

- å¯ä»¥ä½¿ç”¨äº†
```shell
kubectl get node

kubectl get pod --all-namespaces
```

### 1.28ç‰ˆæœ¬

æ–°ç‰ˆçš„è¦ä½¿ç”¨cri-dockeræ‰èƒ½ç”¨docker
- å®‰è£…cri-dockerd
```shell
rpm -ivh libcgroup-0.41-19.el8.x86_64.rpm

rpm -ihv cri-dockerd-0.3.4-3.el7.x86_64.rpm

systemctl daemon-reload

systemctl enable cri-docker.socket cri-docker

systemctl start cri-docker.service
```

- åˆå§‹åŒ–èŠ‚ç‚¹
```shell
kubeadm init \
--apiserver-advertise-address=192.168.0.151 \
--cri-socket=unix:///var/run/cri-dockerd.sock \
--service-cidr=10.1.0.0/16 --pod-network-cidr=10.244.0.0/16
```

- nodeåŠ å…¥èŠ‚ç‚¹
```shell
kubeadm join 192.168.0.151:6443 --token kphcf8.8bkwpcg7svwb2cql \
--discovery-token-ca-cert-hash sha256:2135122a581ab62441bbe534f151918be467d5895614808379240c96f52dba88 \
--cri-socket=unix:///var/run/cri-dockerd.sock 
```



- masterä¹Ÿå¹²æ´»
```shell 
kubectl taint nodes --all node-role.kubernetes.io/control-plane-
```

::: details é‡ç½®é›†ç¾¤

æ‰§è¡Œè¿™ä¸ªå‘½ä»¤å¯ä»¥é‡ç½®é›†ç¾¤
```shell 
kubeadm reset -f --cri-socket=unix:///var/run/cri-dockerd.sock
```
:::

æ€»å¾—æ¥è¯´ï¼Œ1.28ç›¸æ¯”1.18åªæ˜¯å·®åœ¨criçš„åŒºåˆ«ä¸Šï¼Œæˆ‘ä»¬åœ¨å¤„ç†é›†ç¾¤çš„æ—¶å€™éœ€è¦åŠ ä¸Š```--cri-socket=unix:///var/run/cri-dockerd.sock```å‚æ•°

è‡³æ­¤masterå®‰è£…å®Œæ¯•

### å®‰è£…ç½‘ç»œ
> 2é€‰1

- flannel
```shell
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

- calico
```shell
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
```

- å¦‚æœæ˜¯å•èŠ‚ç‚¹çš„è¯ï¼Œä½¿masterå¯ä»¥éƒ¨ç½²pod
```shell
kubectl taint nodes master01 node-role.kubernetes.io/master-
```

- nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤
```shell
kubeadm join 192.168.0.75:6443 --token dq7wsg.leird6167ziiw3mf --discovery-token-ca-cert-hash sha256:63d9ae3a2725024b4dc812c1a2313f5a9a278b2d5afd257f9eff82314c7111ca --v=5
```

### ç»“æŸ
å¦‚æœæœ‰ä¸æ­£ç¡®çš„åœ°æ–¹å¯ä»¥åœ¨è¯„è®ºè¿›è¡Œäº¤æµğŸºğŸºğŸºğŸºğŸºğŸºğŸº

--------------------------

::: details ä¸€äº›å¯èƒ½ä¼šç”¨åˆ°çš„æ“ä½œ

é‡ç½®æ—¶å¯èƒ½å‡ºç°é—®é¢˜

<code-group>
  <code-block title="1.18" active>
  ```bash
kubeadm reset -f

# å¦‚ä½•å¤±è´¥ï¼Œæç¤ºï¼š[reset] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'

# centos 7 å¯èƒ½ä¼šæœ‰è¿™æ ·çš„é—®é¢˜ï¼Œå¦‚æœæ˜¯masteræœºå™¨çš„è¯ï¼Œéœ€è¦å…ˆæ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

rm -rf /etc/kubernetes/*
rm -rf /root/.kube/
rm -rf /var/lib/etcd
  ```
  </code-block>

  <code-block title="1.28">
  ```bash
kubeadm reset -f --cri-socket=unix:///var/run/cri-dockerd.sock
  ```
  </code-block>
</code-group>

æ¸…ç©ºiptablesè§„åˆ™
```shell
iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X
```

masteræ‰§è¡Œï¼Œé‡æ–°åŠ å…¥çš„æŒ‡ä»¤
```shell
kubeadm token create --print-join-command
```

docker ä»£ç†
```shell
vim /etc/docker/daemon.json
```
```json
{
  "proxies": {
    "http-proxy": "http://192.168.0.107:7890",
    "https-proxy": "http://192.168.0.107:7890",
    "no-proxy": "192.168.0.*"
  },
  "registry-mirrors": ["https://reg-mirror.qiniu.com/"]
}
```

:::

